name: Fix and Build DNSTT App

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # 1. SETUP: Generate correct build files and clean Manifest
      - name: Generate Config Files
        run: |
          # Create settings.gradle
          echo "pluginManagement { repositories { google(); mavenCentral(); gradlePluginPortal() } }" > settings.gradle
          echo "dependencyResolutionManagement { repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS); repositories { google(); mavenCentral() } }" >> settings.gradle
          echo "rootProject.name = 'DNSTT Runner'" >> settings.gradle
          echo "include ':app'" >> settings.gradle

          # Create app/build.gradle (AGP 8.2.0)
          mkdir -p app
          echo "plugins { id 'com.android.application' version '8.2.0' }" > app/build.gradle
          echo "android {" >> app/build.gradle
          echo "    namespace 'com.example.dnstt'" >> app/build.gradle
          echo "    compileSdk 34" >> app/build.gradle
          echo "    defaultConfig {" >> app/build.gradle
          echo "        applicationId 'com.example.dnstt'" >> app/build.gradle
          echo "        minSdk 24" >> app/build.gradle
          echo "        targetSdk 34" >> app/build.gradle
          echo "        versionCode 1" >> app/build.gradle
          echo "        versionName '1.0'" >> app/build.gradle
          echo "    }" >> app/build.gradle
          # This line forces the native library to be extracted (replacing the Manifest attribute)
          echo "    packagingOptions { jniLibs { useLegacyPackaging = true } }" >> app/build.gradle
          echo "}" >> app/build.gradle
          echo "dependencies {" >> app/build.gradle
          echo "    implementation 'androidx.appcompat:appcompat:1.6.1'" >> app/build.gradle
          echo "    implementation 'com.google.android.material:material:1.9.0'" >> app/build.gradle
          echo "}" >> app/build.gradle

          # Overwrite Manifest to remove the conflicting 'extractNativeLibs' attribute
          mkdir -p app/src/main
          echo '<?xml version="1.0" encoding="utf-8"?>' > app/src/main/AndroidManifest.xml
          echo '<manifest xmlns:android="http://schemas.android.com/apk/res/android">' >> app/src/main/AndroidManifest.xml
          echo '    <uses-permission android:name="android.permission.INTERNET" />' >> app/src/main/AndroidManifest.xml
          echo '    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />' >> app/src/main/AndroidManifest.xml
          echo '    <application' >> app/src/main/AndroidManifest.xml
          echo '        android:icon="@mipmap/ic_launcher"' >> app/src/main/AndroidManifest.xml
          echo '        android:label="DNSTT Runner">' >> app/src/main/AndroidManifest.xml
          echo '        <activity android:name=".MainActivity" android:exported="true">' >> app/src/main/AndroidManifest.xml
          echo '            <intent-filter>' >> app/src/main/AndroidManifest.xml
          echo '                <action android:name="android.intent.action.MAIN" />' >> app
